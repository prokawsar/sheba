{"version":3,"file":"Profile.js","sources":["../../../src/models/profile.js","../../../src/components/views/Profile.html"],"sourcesContent":["import baseModel from './basemodel.js';\r\nimport Net from '../services/net';\r\n\r\nexport default new class extends baseModel {\r\n  constructor() {\r\n    super();\r\n    this.apiEndpoint = '/profile';\r\n\r\n    this.oldGetOne = this.getOne;\r\n    this.getOne = (endpoint) => {\r\n      return Net.get((endpoint || this.apiEndpoint));\r\n    }\r\n\r\n    this.oldSave = this.save;\r\n    this.save = (payload, endpoint) => {\r\n      return this.oldSave('', payload, endpoint);\r\n    }\r\n\r\n  }\r\n\r\n  uploadAvatar(payload, onprogress) {\r\n    return this.upload(('avatar'), payload, onprogress);\r\n  }\r\n\r\n};","<div class=\"page-content\">\r\n\r\n    <PageTitle {page}>\r\n      <a class=\"button is-info is-inverted is-pulled-right\" href=\"#dashboard\"><Icon icon=\"long-arrow-left\" size=\"small\" /> <span>Back to Dashboard</span></a>\r\n    </PageTitle>\r\n\r\n    <ViewScaffold {is_loading} {is_error} {error_message}>\r\n\r\n      {#if tracker.error}\r\n        <Notification type=\"danger\">\r\n             {error_message}\r\n        </Notification>\r\n      {/if}\r\n\r\n      {#if should_change_password}\r\n        <Message type=\"danger\">\r\n          <h2 class=\"title is-4 has-text-danger\">Please change your password.</h2>\r\n          <h3 class=\"subtitle is-5 has-text-danger\">You will not be able to access any other pages until you have changed your password.</h3>\r\n        </Message>\r\n      {/if}\r\n\r\n      <div class=\"columns\">\r\n        <div class=\"column is-7\">\r\n          <form on:submit=\"save(event)\">\r\n            <Panel title=\"Update Details\">\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">Username</label>\r\n                  <input class=\"input {data.username == '' ? 'is-danger' : ''}\" type=\"text\" bind:value=\"data.username\" />\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">Email</label>\r\n                  <input class=\"input {data.email == '' ? 'is-danger' : ''}\" type=\"email\" bind:value=\"data.email\" data-cy=\"user-email\"/>\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">Name</label>\r\n                  <input class=\"input {data.name == '' ? 'is-danger' : ''}\" type=\"text\" bind:value=\"data.name\" data-cy=\"user-name\"/>\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">Surname</label>\r\n                  <input class=\"input\" type=\"text\" bind:value=\"data.surname\" />\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <SubmitButton icon_size=\"small\" classes=\"is-primary is-pulled-right\" bind:tracker cy=\"save-profile-button\" />\r\n                </p>\r\n              </div>\r\n            </Panel>\r\n          </form>\r\n        </div>\r\n\r\n        <div class=\"column\">\r\n          <Panel title=\"Update Avatar\">\r\n            <div>\r\n              <div class=\"is-text-centered\">\r\n                <figure class=\"image is-128x128\" style=\"margin: 0 auto 20px auto\">\r\n                   {#if data && data.avatarurl}<img src=\"{data.avatarurl}\" alt=\"\" />{/if}\r\n                </figure>\r\n              </div>\r\n              <FileUpload on:file_chosen max=\"1048579\" allowed=\"{['png', 'jpg', 'jpeg']}\" message=\"Upload new avatar...\" />\r\n            </div>\r\n          </Panel>\r\n          <form on:submit=\"updatePassword(event)\">\r\n            <Panel title=\"Update Password\">\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">New Password</label>\r\n                  <input class=\"input {new_pass && !valid ? 'is-danger' : ''}\" type=\"password\" bind:value=\"new_pass\" data-cy=\"user-password\"/>\r\n                  <PasswordValidator {new_pass} bind:valid />\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">Confirm Password</label>\r\n                  <input class=\"input {new_pass != confirm_pass ? 'is-danger' : ''}\" type=\"password\" bind:value=\"confirm_pass\" data-cy=\"user-confirm-password\" />\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <SubmitButton icon_size=\"small\" classes=\"is-primary is-pulled-right\" text=\"Update Password\" bind:tracker=\"password_tracker\" cy=\"save-password-button\"/>\r\n                </p>\r\n              </div>\r\n            </Panel>\r\n          </form>\r\n        </div>\r\n\r\n      </div>\r\n\r\n    </ViewScaffold>\r\n\r\n</div>\r\n\r\n<script>\r\n\r\nimport Model from '../../models/profile.js';\r\nimport { Icon, Notification, Panel, Message } from '@kws3/helpers';\r\nimport { SubmitButton } from '@kws3/buttons';\r\n\r\nexport default {\r\n  components:{\r\n    ViewScaffold: '../helpers/ViewScaffold.html',\r\n    PageTitle: '../helpers/PageTitle.html',\r\n    PasswordValidator:'../helpers/PasswordValidator.html',\r\n    Panel,\r\n    Icon,\r\n    Notification,\r\n    Message,\r\n    SubmitButton,\r\n    FileUpload: '../helpers/FileUpload.html'\r\n  },\r\n  data(){\r\n    return {\r\n      is_loading: true,\r\n      is_error: false,\r\n      error_message: '',\r\n      data:{},\r\n      meta:{},\r\n      page: {\r\n        title: 'My Profile',\r\n        subtitle: 'Update my details',\r\n        icon: 'user-circle-o'\r\n      },\r\n      tracker:{\r\n        saving:false,\r\n        saved:false,\r\n        error:false\r\n      },\r\n      password_tracker:{\r\n        saving:false,\r\n        saved:false,\r\n        error:false\r\n      },\r\n      new_pass: '',\r\n      confirm_pass: '',\r\n      valid:false\r\n    }\r\n  },\r\n  computed: {\r\n    should_change_password: ({$user}) => {\r\n      if($user.should_change_password){\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n  },\r\n  onstate({ changed, current, previous }) {\r\n\r\n    if (changed['$nav']) {\r\n      var { $nav } = current;\r\n      if ($nav.activeView == '_COMPONENT_') {\r\n        this.load();\r\n      }\r\n    }\r\n\r\n  },\r\n  oncreate(){\r\n    this.on('file_chosen', (comp) => {\r\n      var file = comp.getFile();\r\n      var size = file.size;\r\n      comp.progress(0);\r\n\r\n      Model.uploadAvatar(\r\n        file.file,\r\n        (e) => {\r\n          comp.progress(e.loaded);\r\n        }\r\n      ).then((r) => {\r\n        this.set({\r\n          data: r.response\r\n        });\r\n        //update state when profile is saved\r\n        this.fire('updateLoggedIn', {\r\n          name: r.response.name,\r\n          surname:r.response.surname,\r\n          username: r.response.username,\r\n          email:r.response.email,\r\n          avatar: r.response.avatarurl,\r\n          should_change_password:r.response.should_change_password,\r\n        });\r\n        comp.uploaded();\r\n      })\r\n      .catch((r) => {\r\n        var user_message = \"Failed to upload!\";\r\n        if (typeof r != 'undefined' && typeof r.response != 'undefined' && typeof r.response.records != 'undefined'){\r\n            user_message = r.response.records.userMessage;\r\n        }\r\n        comp.error(user_message);\r\n      });\r\n    });\r\n\r\n\r\n    this.load();\r\n\r\n  },\r\n  methods:{\r\n    load(){\r\n      this.set({\r\n        is_loading: true,\r\n        is_error: false\r\n      });\r\n      Model.getOne()\r\n      .then((r) => {\r\n        this.set({\r\n          is_loading: false,\r\n          meta: r._meta,\r\n          data: r.response\r\n        });\r\n      })\r\n      .catch((r) => {\r\n        var user_message = '';\r\n        if (typeof r != 'undefined' && typeof r.response != 'undefined' && typeof r.response.records != 'undefined'){\r\n            user_message = r.response.records.userMessage;\r\n        }\r\n        this.set({\r\n          is_error: true,\r\n          is_loading: false,\r\n          error_message: user_message\r\n        });\r\n      });\r\n    },\r\n    updatePassword(e){\r\n      e.preventDefault();\r\n\r\n      var { new_pass, confirm_pass, valid }  = this.get();\r\n\r\n      if(new_pass == ''){\r\n        return;\r\n      }\r\n      if(new_pass !== confirm_pass || !valid){\r\n        return;\r\n      }\r\n\r\n      this.set({\r\n        password_tracker:{\r\n          saving:true,\r\n          saved: false,\r\n          error:false\r\n        }\r\n      });\r\n\r\n      Model.save({password: new_pass})\r\n      .then((r) => {\r\n\r\n        //update state when profile is saved\r\n        this.fire('updateLoggedIn', {\r\n          name: r.response.name,\r\n          surname:r.response.surname,\r\n          username: r.response.username,\r\n          email:r.response.email,\r\n          avatar: r.response.avatarurl,\r\n          should_change_password:r.response.should_change_password,\r\n        });\r\n\r\n        this.set({\r\n          password_tracker:{\r\n            saving:false,\r\n            saved: true,\r\n            error:false,\r\n          },\r\n          new_pass: '',\r\n          confirm_pass: ''\r\n        });\r\n\r\n        setTimeout(() => {\r\n          this.set({password_tracker:{saved:false}});\r\n        }, 3000);\r\n\r\n      })\r\n      .catch((r) => {\r\n\r\n        this.set({\r\n          password_tracker:{\r\n            saving:false,\r\n            saved: false,\r\n            error:true,\r\n          }\r\n        });\r\n\r\n        setTimeout(() => {\r\n          this.set({password_tracker:{error:false}});\r\n        }, 3000);\r\n\r\n      });\r\n\r\n    },\r\n    save(e){\r\n      e.preventDefault();\r\n\r\n      var { data } = this.get();\r\n\r\n      if(data.name == ''){\r\n        return;\r\n      }\r\n      if(data.username == ''){\r\n        return;\r\n      }\r\n\r\n      this.set({\r\n        tracker:{\r\n          saving:true,\r\n          saved: false,\r\n          error:false\r\n        }\r\n      });\r\n\r\n      Model.save(data)\r\n      .then((r) => {\r\n\r\n        this.set({data:r.response});\r\n\r\n        this.set({\r\n          tracker:{\r\n            saving:false,\r\n            saved: true,\r\n            error:false\r\n          }\r\n        });\r\n\r\n        this.fire('updateLoggedIn', {\r\n          name: r.response.name,\r\n          surname: r.response.surname,\r\n          username: r.response.username,\r\n          email: r.response.email,\r\n          avatar: r.response.avatarurl,\r\n          should_change_password:r.response.should_change_password,\r\n        });\r\n\r\n        setTimeout(() => {\r\n          this.set({tracker:{saved:false}});\r\n        }, 3000);\r\n\r\n      })\r\n      .catch((r) => {\r\n        if (r.response.records.errorCode == '406') {\r\n          this.set({ error_message: ' The username you entered already exists, Please try another one' });\r\n        } else {\r\n          this.set({ error_message: 'There was an error updating profile' });\r\n        }\r\n        this.set({\r\n          tracker:{\r\n            saving:false,\r\n            saved: false,\r\n            error:true\r\n          }\r\n        });\r\n\r\n        setTimeout(() => {\r\n          this.set({tracker:{error:false}});\r\n        }, 3000);\r\n\r\n      });\r\n\r\n    }\r\n  }\r\n}\r\n</script>\r\n"],"names":["baseModel","[object Object]","super","this","apiEndpoint","oldGetOne","getOne","endpoint","Net","get","oldSave","save","payload","onprogress","upload","$user","should_change_password","is_loading","is_error","error_message","data","meta","page","title","subtitle","icon","tracker","saving","saved","error","password_tracker","new_pass","confirm_pass","valid","set","Model","then","r","_meta","response","catch","user_message","records","userMessage","e","preventDefault","password","fire","name","surname","username","email","avatar","avatarurl","setTimeout","errorCode","on","comp","file","getFile","size","progress","uploadAvatar","loaded","uploaded","load","changed","current","previous","$nav","activeView","event","updatePassword"],"mappings":"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"}