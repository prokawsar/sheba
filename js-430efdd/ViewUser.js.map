{"version":3,"file":"ViewUser.js","sources":["../../../src/components/views/ViewUser.html"],"sourcesContent":["<div class=\"page-content\">\r\n\r\n  <PageTitle page=\"{page}\">\r\n    <a class=\"button is-info is-pulled-right\" href=\"#users\">\r\n      <Icon icon=\"long-arrow-left\" size=\"small\" />\r\n      <span>Back to All Users</span>\r\n    </a>\r\n  </PageTitle>\r\n\r\n  <ViewScaffold {is_loading} {is_error} {error_message}>\r\n\r\n    {#if tracker.error}\r\n    <Notification type=\"danger\">\r\n      {error_message}\r\n    </Notification>\r\n    {/if}\r\n\r\n    {#if is_api_key}\r\n      <Panel title=\"API Key Details\">\r\n        <div slot=\"toolbar\">\r\n          <DeleteButton text=\"Delete API Key\" on:erase on:erased></DeleteButton>\r\n        </div>\r\n\r\n        <table class=\"table\">\r\n          <tr>\r\n            <th>Key type</th>\r\n            <td>{roles[data.role]}</td>\r\n          </tr>\r\n          <tr>\r\n            <th>API Key</th>\r\n            <td>{data.username}</td>\r\n          </tr>\r\n          <tr>\r\n            <th>Description</th>\r\n            <td>{data.name}</td>\r\n          </tr>\r\n        </table>\r\n\r\n      </Panel>\r\n    {:else}\r\n      <div class=\"columns\">\r\n        <div class=\"column is-7\">\r\n          <form on:submit=\"save(event)\">\r\n            <Panel title=\"Update Details\">\r\n              <div slot=\"toolbar\">\r\n                <DeleteButton text=\"Delete User\" on:erase on:erased></DeleteButton>\r\n              </div>\r\n              <div class=\"columns is-multiline\">\r\n                <div class=\"column is-6\">\r\n                  <div class=\"field\">\r\n                    <p class=\"control\">\r\n                      <label class=\"label\">Role</label>\r\n                      <span class=\"select is-fullwidth\">\r\n                        <select class=\"input {data.role == '' ? 'is-danger' : ''}\" bind:value=\"data.role\" {disabled}>\r\n                          <option value=\"\">Select Role</option>\r\n                          {#each Object.entries(roles) as role}\r\n                            <option value=\"{role[0]}\">{role[1]}</option>\r\n                          {/each}\r\n                        </select>\r\n                      </span>\r\n                    </p>\r\n                  </div>\r\n                  <div class=\"field\">\r\n                    <p class=\"control\">\r\n                      <label class=\"label\">Username</label>\r\n                      <input class=\"input\" type=\"text\" required bind:value=\"data.username\" {disabled}/>\r\n                    </p>\r\n                  </div>\r\n                  <div class=\"field\">\r\n                    <p class=\"control\">\r\n                      <label class=\"label\">Email</label>\r\n                      <input class=\"input\" type=\"email\" bind:value=\"data.email\" />\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <div class=\"column is-6\">\r\n                  <div class=\"field\">\r\n                    <p class=\"control\">\r\n                      <label class=\"label\">Name</label>\r\n                      <input class=\"input\" type=\"text\" required bind:value=\"data.name\" {disabled}/>\r\n                    </p>\r\n                  </div>\r\n                  <div class=\"field\">\r\n                    <p class=\"control\">\r\n                      <label class=\"label\">Surname</label>\r\n                      <input class=\"input \" type=\"text\" bind:value=\"data.surname\" />\r\n                    </p>\r\n                  </div>\r\n                  <div class=\"field\">\r\n                    <p class=\"control\">\r\n                      <label class=\"label\">&nbsp;</label>\r\n                      <SubmitButton classes=\"is-primary is-pulled-right\" bind:tracker />\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </Panel>\r\n          </form>\r\n        </div>\r\n\r\n        <div class=\"column\">\r\n          <Panel title=\"Update Avatar\">\r\n            <div>\r\n              <div class=\"is-text-centered\">\r\n                <figure class=\"image is-128x128\" style=\"margin: 0 auto 20px auto\">\r\n                  {#if data && data.avatarurl}\r\n                  <img src=\"{data.avatarurl}\" alt=\"\" />{/if}\r\n                </figure>\r\n              </div>\r\n              <FileUpload on:file_chosen max=\"1048579\" allowed=\"{['png', 'jpg', 'jpeg']}\" message=\"Upload new avatar...\" />\r\n            </div>\r\n          </Panel>\r\n          <form on:submit=\"updatePassword(event)\">\r\n            <Panel title=\"Update Password\">\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">New Password</label>\r\n                  <input class=\"input {new_pass && !valid ? 'is-danger' : ''}\" type=\"password\" bind:value=\"new_pass\" />\r\n                  <PasswordValidator {new_pass} bind:valid />\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <label class=\"label\">Confirm Password</label>\r\n                  <input class=\"input {new_pass != confirm_pass ? 'is-danger' : ''}\" type=\"password\" bind:value=\"confirm_pass\" />\r\n                </p>\r\n              </div>\r\n              <div class=\"field\">\r\n                <p class=\"control\">\r\n                  <SubmitButton icon_size=\"small\" classes=\"is-primary is-pulled-right\" text=\"Update Password\" bind:tracker=\"password_tracker\"\r\n                  />\r\n                </p>\r\n              </div>\r\n            </Panel>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    {/if}\r\n\r\n  </ViewScaffold>\r\n</div>\r\n\r\n<script>\r\n  import Model from '../../models/users';\r\n  import Router from '../../services/router';\r\n  import { Icon, Notification, Panel } from '@kws3/helpers';\r\n  import { DeleteButton, SubmitButton } from '@kws3/buttons';\r\n\r\n  export default {\r\n    components: {\r\n      ViewScaffold: '../helpers/ViewScaffold.html',\r\n      PageTitle: '../helpers/PageTitle.html',\r\n      PasswordValidator:'../helpers/PasswordValidator.html',\r\n      Panel,\r\n      Icon,\r\n      Notification,\r\n      DeleteButton,\r\n      SubmitButton,\r\n      FileUpload: '../helpers/FileUpload.html'\r\n    },\r\n\r\n    data() {\r\n      return {\r\n        is_loading: true,\r\n        is_error: false,\r\n        error_message: '',\r\n        data: {\r\n          role: '',\r\n          name: '',\r\n          surname: '',\r\n          email: '',\r\n          password: ''\r\n        },\r\n        meta: {},\r\n        tracker: {\r\n          saving: false,\r\n          saved: false,\r\n          error: false,\r\n        },\r\n        new_pass: '',\r\n        confirm_pass: '',\r\n        page: {\r\n          title: 'View User',\r\n          subtitle: 'Change user details',\r\n          icon: 'vcard-o',\r\n          icon_badge: 'pencil'\r\n        },\r\n        password_tracker:'',\r\n        roles: {},\r\n        valid:false\r\n      }\r\n    },\r\n    computed: {\r\n      entityId({ $nav }) {\r\n        return $nav && $nav.params[0];\r\n      },\r\n      user_role: ({ $user }) => $user && $user.role,\r\n      is_api_key: ({ data }) => ['AK'].indexOf(data.role) != -1\r\n    },\r\n    onstate({ changed, current, previous }) {\r\n      var self = this;\r\n\r\n      if (changed['$nav']) {\r\n        var { $nav } = current;\r\n        if ($nav.activeView == '_COMPONENT_') {\r\n          self.load();\r\n        }\r\n      }\r\n    },\r\n    oncreate() {\r\n\r\n      this.on('erase',  (comp) => {\r\n        comp.doing();\r\n        Model.delete(this.get().entityId)\r\n          .then( (r) => {\r\n            comp.done();\r\n          })\r\n          .catch( () => {\r\n            comp.error();\r\n          });\r\n      });\r\n\r\n      this.on('erased', (comp) => {\r\n        Router.navigate('users');\r\n      });\r\n\r\n      this.on('file_chosen', (comp) => {\r\n        var file = comp.getFile();\r\n        var size = file.size;\r\n        comp.progress(0);\r\n\r\n        Model.uploadAvatar(\r\n          this.get().entityId,\r\n          file.file,\r\n          (e) => {\r\n            comp.progress(e.loaded);\r\n          }\r\n        ).then( (r) => {\r\n          this.set({\r\n            data: r.response\r\n          });\r\n          comp.uploaded();\r\n        })\r\n          .catch( (r) => {\r\n            var user_message = \"Failed to upload!\";\r\n            if (typeof r != 'undefined' && typeof r.response != 'undefined' && typeof r.response.records != 'undefined') {\r\n              user_message = r.response.records.userMessage;\r\n            }\r\n            comp.error(user_message);\r\n          });\r\n      });\r\n\r\n      this.load();\r\n    },\r\n    methods: {\r\n      load() {\r\n        var uid = this.get().entityId;\r\n\r\n        this.set({\r\n          'is_loading': true,\r\n          'is_error': false\r\n        });\r\n\r\n        Model && Model.getOne(uid, this.get().user_role)\r\n          .then( (r) => {\r\n            this.set({\r\n              'is_loading': false,\r\n              'meta': r[1]._meta,\r\n              'roles':r[0].response,\r\n              'data': r[1].response\r\n            });\r\n          })\r\n          .catch( (r) => {\r\n            var user_message = '';\r\n            if (typeof r != 'undefined' && typeof r.response != 'undefined' && typeof r.response.records != 'undefined') {\r\n              user_message = r.response.records.userMessage;\r\n            }\r\n            this.set({\r\n              'is_error': true,\r\n              'is_loading': false,\r\n              'error_message': user_message\r\n            });\r\n          });\r\n      },\r\n      updatePassword(e) {\r\n        e.preventDefault();\r\n\r\n        var { new_pass, confirm_pass, entityId, valid} = this.get();\r\n\r\n        if (new_pass == '') {\r\n          return;\r\n        }\r\n        if (new_pass !== confirm_pass || !valid) {\r\n          return;\r\n        }\r\n\r\n        this.set({\r\n          password_tracker: {\r\n            saving: true,\r\n            saved: false,\r\n            error: false\r\n          }\r\n        });\r\n\r\n        Model.save( entityId , { password: new_pass })\r\n          .then( (r) => {\r\n\r\n            this.set({\r\n              password_tracker: {\r\n                saving: false,\r\n                saved: true,\r\n                error: false,\r\n              },\r\n              new_pass: '',\r\n              confirm_pass: ''\r\n            });\r\n\r\n            setTimeout( () => {\r\n              this.set({ password_tracker: { saved: false } });\r\n            }, 3000);\r\n\r\n          })\r\n          .catch( (r) => {\r\n\r\n            this.set({\r\n              password_tracker: {\r\n                saving: false,\r\n                saved: false,\r\n                error: true,\r\n              }\r\n            });\r\n\r\n            setTimeout( () => {\r\n              this.set({ password_tracker: { error: false } });\r\n            }, 3000);\r\n\r\n          });\r\n\r\n      },\r\n      save(e) {\r\n        e.preventDefault();\r\n\r\n        var { data, entityId } = this.get();\r\n\r\n        this.set({\r\n          tracker: {\r\n            saving: true,\r\n            saved: false,\r\n            error: false\r\n          }\r\n        });\r\n\r\n        Model.save(entityId, data)\r\n          .then( (r) => {\r\n\r\n            this.set({ data: r.response });\r\n\r\n            this.set({\r\n              tracker: {\r\n                saving: false,\r\n                saved: true,\r\n                error: false\r\n              }\r\n            });\r\n\r\n            setTimeout( () => {\r\n              this.set({ tracker: { saved: false } });\r\n            }, 3000);\r\n\r\n          })\r\n          .catch( (r) => {\r\n            if (r.response.records.errorCode == '406') {\r\n              this.set({ error_message: ' The username you entered already exists, Please try another one' });\r\n            } else {\r\n              this.set({ error_message: 'There was an error adding user' });\r\n            }\r\n            this.set({\r\n              tracker: {\r\n                saving: false,\r\n                saved: false,\r\n                error: true\r\n              }\r\n            });\r\n\r\n            setTimeout( () => {\r\n              this.set({ tracker: { error: false } });\r\n            }, 3000);\r\n\r\n          });\r\n\r\n      }\r\n    }\r\n  }\r\n\r\n</script>"],"names":["$nav","params","$user","role","data","indexOf","is_loading","is_error","error_message","name","surname","email","password","meta","tracker","saving","saved","error","new_pass","confirm_pass","page","title","subtitle","icon","icon_badge","password_tracker","roles","valid","[object Object]","uid","this","get","entityId","set","Model","getOne","user_role","then","r","_meta","response","catch","user_message","records","userMessage","e","preventDefault","save","setTimeout","errorCode","on","comp","doing","delete","done","Router","navigate","file","getFile","size","progress","uploadAvatar","loaded","uploaded","load","changed","current","previous","activeView","is_api_key","Object","entries","length","username","event","avatarurl","updatePassword","disabled"],"mappings":"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"}